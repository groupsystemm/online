@app.route('/admin/view-all-grades')
def view_all_grades():
    if session.get('role') != 'admin':
        return redirect('/login')
    try:
        conn = create_connection()
        cursor = conn.cursor(dictionary=True)
        cursor.execute("""
            SELECT s.name AS student_name, s.email, c.course_name,
                   g.mid_exam, g.final_exam, g.assignment, g.quiz, g.grade
            FROM grades g
            JOIN students s ON g.student_id = s.id
            JOIN courses c ON g.course_id = c.id
        """)
        all_grades = cursor.fetchall()
        cursor.close()
        conn.close()

        def letter(g):
            if g is None:
                return "-"
            g = float(g)
            if g >= 92: return "A+"
            elif g >= 85: return "A"
            elif g >= 75: return "B+"
            elif g >= 65: return "B"
            elif g >= 50: return "C"
            else: return "F"

        for row in all_grades:
            mid = row.get('mid_exam') or 0
            final = row.get('final_exam') or 0
            assignment = row.get('assignment') or 0
            quiz = row.get('quiz') or 0
            total = round(mid + final + assignment + quiz, 2)
            row['grade'] = total
            row['letter'] = letter(total)

        return render_template('admin_all_grades.html', grades=all_grades)

    except Exception as e:
        return f"<h2>ðŸ”¥ Internal Server Error:</h2><pre>{e}</pre>"
